# SearchSRAToolKit

Tools for processing data generated by the Search SRA.

These tools are provided as-is!

The [SearchSRA](https://www.searchsra.org) provides a simple way to search a nucleotide or protein sequence against the metagenomes available in the [Sequence Read Archive](https://www.ncbi.nlm.nih.gov/sra), and these tools are designed to complement those searches.

A search against [SearchSRA](https://www.searchsra.org) will generate hundreds of thousands of `.bam` or `.m8` files for nucleotide and protein searches respectively. 

You can filter those searches and generate summary tables using these tools

# Nucleotide Searches

We recommend starting with `filter_reads.sh`, a unified bash script that will extract your results, filter them based on some criteria you specify, and then summarize the hits against the projects in the SRA.

<small>Note: a similar approach is provided in the two snakemake files, `process_expand.smk` and `process.smk`, but we recommend the bash script because snakemake doesn't handle hundreds of thousands of files well!. YMMV</small>

To run this script, download the `results.zip` archive from searchSRA and copy it to the location of these files. Then:

```command-line
./filter_reads.sh -m 20 -l 100 -v -o FILTERED
```

This will filter for matches with a MAPQ alignment score of >= 20, and an alignment length of >= 100 nucleotides.

Please [see this description](http://biofinysics.blogspot.com/2014/05/how-does-bowtie2-assign-mapq-scores.html) to decide which MAPQ score to filter on.

MAPQ | Approximate Meaning
--- | ---
0 | No filtering
2 | exclude "true multireads" and uniquely mapping reads with >=4 mismatches
3 | allows up to 3 mismatches in high quality bases and unireads
23 | allows up to 2 mismatches in high quality bases and unireads
40 | allows up to 1 mismatch
42 | allows 0 mismatches


This will end up generating four outputs:

- `FILTERED/FILTERED_MAPQ20_LEN100` is the bam files filtered on MAPQ score and alignment length. 
- `FILTERED/IDXSTATS_MAPQ20_LEN100` is the summary per SRA Run ID of the contigs and number of hits
- `FILTERED/reads_per_project.Q20.L100.tsv` is the combined summary of all the data in a matrix that has the number of rows equal to the number of SRA **Projects** that match your sequence(s) and the number of columns as 5 plus the number of sequences in your file (see below)
- `FILTERED/reads_per_sample.Q20.L100.tsv` has a simple summary of SRA Project, SRA Run, Contig name, Number of hits

The additional five columns in `reads_per_project.Q20.L100.tsv` are:
- Project 
- Title 
- Abstract
- Annotation
- Comment
- Average number of hits

Note that if you have a project your are interested in, you'll need to `grep` for that in `reads_per_sample.Q20.L100.tsv` and then look at those runs using (e.g.) samtools.

